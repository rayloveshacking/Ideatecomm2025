<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Buddy Matching - Anchor by Ageless Bicyclists</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="../style/styles.css">
    <script>
        let currentParticipantId = null;
        let participants = [];
        let matchData = [];

        function initResponsiveNav() {
            const navContainer = document.querySelector('.nav-container');
            const toggle = document.querySelector('.nav-toggle');
            const navList = document.getElementById('primary-navigation');
            if (!navContainer || !toggle || !navList) return;

            const toggleIcon = toggle.querySelector('i');

            const closeMenu = () => {
                navContainer.dataset.menuOpen = 'false';
                toggle.setAttribute('aria-expanded', 'false');
                if (toggleIcon) {
                    toggleIcon.classList.add('fa-bars');
                    toggleIcon.classList.remove('fa-xmark');
                }
            };

            toggle.addEventListener('click', (event) => {
                event.stopPropagation();
                const isOpen = navContainer.dataset.menuOpen === 'true';
                const nextState = !isOpen;
                navContainer.dataset.menuOpen = String(nextState);
                toggle.setAttribute('aria-expanded', String(nextState));
                if (toggleIcon) {
                    toggleIcon.classList.toggle('fa-bars', !nextState);
                    toggleIcon.classList.toggle('fa-xmark', nextState);
                }
            });

            document.addEventListener('click', (event) => {
                if (!navContainer.contains(event.target)) {
                    closeMenu();
                }
            });

            navList.querySelectorAll('a').forEach((link) => {
                link.addEventListener('click', () => closeMenu());
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth > 640) {
                    closeMenu();
                }
            });

            closeMenu();
        }

        function loadParticipants() {
            fetch('http://localhost:3000/api/participants')
            .then(response => response.json())
            .then(data => {
                participants = data;
                const select = document.getElementById('participant-select');
                select.innerHTML = '<option value="">Select a participant...</option>' +
                    participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            })
            .catch(error => console.error('Error loading participants:', error));
        }

        function getCompatibilityColor(score) {
            if (score >= 0.8) return 'text-green-600';
            if (score >= 0.6) return 'text-amber-600';
            return 'text-slate-600';
        }

        function getCompatibilityBg(score) {
            if (score >= 0.8) return 'bg-green-50 border-green-200';
            if (score >= 0.6) return 'bg-amber-50 border-amber-200';
            return 'bg-slate-50 border-slate-200';
        }

        function loadMatches() {
            const participantId = document.getElementById('participant-select').value;
            if (!participantId) {
                document.getElementById('matches-container').innerHTML = '';
                return;
            }

            currentParticipantId = participantId;
            const participant = participants.find(p => p.id === participantId);

            // Display participant profile
            if (participant) {
                document.getElementById('participant-profile').innerHTML = `
                    <div class="glass-card glass-card--light">
                        <h3 class="text-2xl font-bold text-slate-900 mb-4">
                            <i class="fa-solid fa-user"></i> ${participant.name}
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-slate-700 mb-2"><i class="fa-solid fa-volume-high"></i> Sensory Profile</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${Object.entries(participant.sensoryProfile || {}).map(([key, value]) => 
                                        `<span class="chip ${value === 'sensitive' ? 'bg-rose-100 text-rose-700' : 'bg-green-100 text-green-700'}">
                                            ${key}: ${value}
                                        </span>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-slate-700 mb-2"><i class="fa-solid fa-hand-holding-heart"></i> Support Needs</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${(participant.supportNeeds || []).map(need => 
                                        `<span class="chip">${need.replace(/-/g, ' ')}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-slate-700 mb-2"><i class="fa-solid fa-star"></i> Strengths</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${(participant.strengths || []).map(strength => 
                                        `<span class="chip bg-purple-100 text-purple-700">${strength}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            fetch(`http://localhost:3000/api/participants/${participantId}/matches`)
            .then(response => response.json())
            .then(data => {
                matchData = data;
                const container = document.getElementById('matches-container');
                
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state col-span-full">
                            <i class="fa-solid fa-users-slash text-4xl mb-3"></i>
                            <p>No compatible volunteers found. Try adjusting the matching criteria.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.map(match => `
                    <article class="glass-card glass-card--light ${getCompatibilityBg(match.score.overall)}">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-2xl font-bold text-slate-900">${match.volunteer.name}</h3>
                                <p class="text-sm text-slate-600">${match.volunteer.email}</p>
                            </div>
                            <div class="text-center">
                                <div class="${getCompatibilityColor(match.score.overall)} text-3xl font-extrabold">
                                    ${Math.round(match.score.overall * 100)}%
                                </div>
                                <p class="text-xs text-slate-600 mt-1">Match Score</p>
                            </div>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-slate-700">
                                    <i class="fa-solid fa-comments"></i> Communication
                                </span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: ${match.score.communication * 100}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">${Math.round(match.score.communication * 100)}%</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-slate-700">
                                    <i class="fa-solid fa-volume-high"></i> Sensory Match
                                </span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: ${match.score.sensory * 100}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">${Math.round(match.score.sensory * 100)}%</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-slate-700">
                                    <i class="fa-solid fa-heart"></i> Personality
                                </span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: ${match.score.personality * 100}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">${Math.round(match.score.personality * 100)}%</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-slate-700">
                                    <i class="fa-solid fa-award"></i> Experience
                                </span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: ${match.score.experience * 100}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">${Math.round(match.score.experience * 100)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-slate-700 mb-2">Personality Traits</h4>
                            <div class="flex flex-wrap gap-2">
                                ${Object.entries(match.profile.personalityTraits || {}).map(([trait, score]) => 
                                    `<span class="chip">${trait}: ${score}/10</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-slate-700 mb-2">Sensory Preferences</h4>
                            <div class="flex flex-wrap gap-2">
                                ${Object.entries(match.profile.sensoryPreferences || {}).map(([sense, pref]) => 
                                    `<span class="chip bg-blue-100 text-blue-700">${sense}: ${pref}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        ${match.profile.experience.length > 0 ? `
                            <div class="mb-4">
                                <h4 class="font-semibold text-slate-700 mb-2">ASD Experience</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${match.profile.experience.map(exp => 
                                        `<span class="chip bg-purple-100 text-purple-700">${exp}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <button onclick="assignBuddy('${match.volunteer.id}')" 
                            class="btn btn-primary w-full justify-center ${match.score.overall >= 0.6 ? '' : 'opacity-50'}">
                            <i class="fa-solid fa-user-check"></i> Assign as Buddy
                        </button>
                    </article>
                `).join('');
            })
            .catch(error => console.error('Error loading matches:', error));
        }

        function assignBuddy(volunteerId) {
            if (!currentParticipantId) return;
            
            if (!confirm('Are you sure you want to assign this volunteer as a buddy?')) {
                return;
            }
            
            fetch(`http://localhost:3000/api/participants/${currentParticipantId}/assign-buddy/${volunteerId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(`Successfully assigned buddy! Match score: ${Math.round(data.matchScore * 100)}%`);
                loadMatches();
            })
            .catch(error => console.error('Error assigning buddy:', error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            initResponsiveNav();
            loadParticipants();
        });
    </script>
    <style>
        .progress-bar {
            width: 120px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #f97316, #ec4899);
            transition: width 0.3s ease;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="nav-container" data-menu-open="false">
            <a class="brand-link" href="index.html">
                <span class="brand-emblem"><i class="fa-solid fa-bicycle"></i></span>
                <span>Ageless Bicyclists</span>
            </a>
            <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-navigation">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa-solid fa-bars"></i>
            </button>
            <nav id="primary-navigation" class="nav-list">
                <a href="index.html" class="nav-link">Home</a>
                <a href="signup.html" class="nav-link">Join</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="events.html" class="nav-link">Events</a>
                <a href="stories.html" class="nav-link">Stories</a>
                <a href="buddy-matching.html" class="nav-link nav-link--active">Matching</a>
                <a href="onboarding.html" class="nav-link">Resources</a>
                <a href="vr-training.html" class="nav-link">VR Training</a>
                <a href="admin.html" class="nav-link">Admin</a>
            </nav>
        </div>
    </header>

    <main class="page-shell">
        <section class="hero-card">
            <article class="space-y-5">
                <span class="hero-eyebrow"><i class="fa-solid fa-people-arrows"></i> ASD-optimized matching</span>
                <h1 class="hero-title">Finding the perfect cycling buddy pair.</h1>
                <p class="hero-summary">Anchor's matching algorithm considers communication styles, sensory preferences, personality traits, and ASD-specific experience to create meaningful cycling partnerships that last.</p>
            </article>

            <article class="glass-card glass-card--light">
                <span class="tag"><i class="fa-solid fa-microscope"></i> How it works</span>
                <h2 class="mt-3 text-2xl font-extrabold text-slate-900">Weighted Compatibility Algorithm</h2>
                <div class="metric-ticker mt-5">
                    <div class="metric-card">
                        <span class="metric-label">40%</span>
                        <p class="text-sm text-slate-600 mt-2">Sensory Match Weight</p>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">30%</span>
                        <p class="text-sm text-slate-600 mt-2">Communication Style</p>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">20%</span>
                        <p class="text-sm text-slate-600 mt-2">Personality Fit</p>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">10%</span>
                        <p class="text-sm text-slate-600 mt-2">ASD Experience</p>
                    </div>
                </div>
                <p class="mt-4 text-slate-600 text-sm">Our algorithm prioritizes sensory compatibility—the most critical factor for successful ASD interactions—while balancing communication styles, personality alignment, and volunteer experience.</p>
            </article>
        </section>

        <section class="glass-card glass-card--light mb-8">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">
                <i class="fa-solid fa-filter"></i> Find Compatible Buddies
            </h2>
            <div class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">Select Participant</label>
                <select id="participant-select" onchange="loadMatches()"
                    class="w-full rounded-xl border border-slate-200 bg-white/85 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    <option value="">Select a participant...</option>
                </select>
            </div>
            
            <div id="participant-profile"></div>
        </section>

        <section class="cards-grid" id="matches-container">
            <div class="empty-state col-span-full">
                <i class="fa-solid fa-arrow-up text-4xl mb-3"></i>
                <p>Select a participant above to see compatible volunteer matches</p>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        &copy; 2025 Ageless Bicyclists · Anchor Platform · Better matches, better rides
    </footer>
</body>
</html>
